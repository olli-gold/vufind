<?
  // Set up some variables for convenience:
  $id = $this->driver->getUniqueId();
  $controllerClass = 'controller:' . $this->record($this->driver)->getController();
  $cart = $this->cart();
  $cartId = $this->driver->getResourceSource() . '|' . $id;
?>
<div class="<?=$this->driver->supportsAjaxStatus()?'ajaxItem ':''?>col-xs-12">
  <div class="row">
    <div class="col-md-2 col-sm-3 col-xs-4 left">
      <input type="hidden" value="<?=$this->escapeHtmlAttr($this->driver->getUniqueID())?>" class="hiddenId" />
      <input type="hidden" value="<?=$this->escapeHtmlAttr($this->driver->getResourceSource())?>" class="hiddenSource" />
      <a href="<?=$this->driver->getTubdokUrl()?>">
          <img class="recordcover recordcover" src="<?=$this->imageLink('tub/tubdok-icon.gif')?>" alt="<?=$this->transEsc('No Cover Image')?>"/>
      </a>
      <span class="tub-resultnumber"><?=$this->recordNumber?></span>
    </div>
    <div class="col-md-7 col-sm-9 col-xs-8 middle"> <!-- version for not breaking already at 991 (sm): col-md-7 col-sm-6 col-xs-8 middle -->
      <div class="row tub-middle-top">
        <div class="col-xs-11 tub-bibliographic">
        <a href="<?=$this->driver->getTubdokUrl()?>" class="title">
        <?
          $summHighlightedTitle = $this->driver->getHighlightedTitle();
          $summTitle = $this->driver->getTitle();
          if (!empty($summHighlightedTitle)) {
            echo $this->highlight($this->addEllipsis($summHighlightedTitle, $summTitle));
          } else if (!empty($summTitle)) {
            echo $this->escapeHtml($this->truncate($summTitle, 180));
          } else {
            echo $this->transEsc('Title not available');
          }
        ?>
        </a>

      <div>
        <? if($this->driver->isCollection()): ?>
          <?=implode('<br>', array_map(array($this, 'escapeHtml'), $this->driver->getSummary())); ?>
        <? else: ?>
          <? $summAuthor = $this->driver->getPrimaryAuthor(); if (!empty($summAuthor)): ?>
          <?=$this->transEsc('by')?>
          <a href="<?=$this->record($this->driver)->getLink('author', $summAuthor)?>"><?
            $summHighlightedAuthor = $this->driver->getHighlightedAuthor();
            echo !empty($summHighlightedAuthor)
                ? $this->highlight($summHighlightedAuthor)
                : $this->escapeHtml($summAuthor);
          ?></a>
          <? endif; ?>

          <? $journalTitle = $this->driver->getContainerTitle(); $summDate = $this->driver->getPublicationDates(); ?>
          <? if (!empty($journalTitle)): ?>
            <?=!empty($summAuthor) ? '<br />' : ''?>
            <?=$this->transEsc('Published in')?>
            <? $containerID = $this->driver->getContainerRecordID(); ?>
            <? /* TODO: handle highlighting more elegantly here: */?>
            <a href="<?=($containerID ? $this->recordLink()->getUrl("VuFind|$containerID") : $this->record($this->driver)->getLink('journaltitle', str_replace(array('{{{{START_HILITE}}}}', '{{{{END_HILITE}}}}'), '', $journalTitle)))?>"><?=$this->highlight($journalTitle) ?></a>
            <?=!empty($summDate) ? ' (' . $this->escapeHtml($summDate[0]) . ')' : ''?>
          <? endif; ?>
          <? $summInCollection = $this->driver->getContainingCollections(); if (!empty($summInCollection)): ?>
            <? foreach ($summInCollection as $collId => $collText): ?>
              <div>
                <b><?=$this->transEsc("in_collection_label")?></b>
                <a class="collectionLinkText" href="<?=$this->url('collection', array('id' => $collId))?>?recordID=<?=urlencode($this->driver->getUniqueID())?>">
                  <?=$this->escapeHtml($collText)?>
                </a>
              </div>
            <? endforeach; ?>
          <? endif; ?>
        <? endif; ?>
      </div>

      <? if(!$this->driver->isCollection()): ?>
        <? if ($snippet = $this->driver->getHighlightedSnippet()): ?>
          <? if (!empty($snippet['caption'])): ?>
            <strong><?=$this->transEsc($snippet['caption']) ?>:</strong> ';
          <? endif; ?>
          <? if (!empty($snippet['snippet'])): ?>
            <span class="quotestart">&#8220;</span>...<?=$this->highlight($snippet['snippet']) ?>...<span class="quoteend">&#8221;</span><br/>
          <? endif; ?>
        <? endif; ?>
      <? endif; ?>

      <?
      /* Display information on duplicate records if available */
      $dedupData = $this->driver->getDedupData();
      if ($dedupData): ?>
      <div class="dedupInformation">
      <?
        $i = 0;
        foreach ($dedupData as $source => $current) {
          if (++$i == 1) {
            ?><span class="currentSource"><a href="<?=$this->recordLink()->getUrl($this->driver)?>"><?=$this->transEsc("source_$source", array(), $source)?></a></span><?
          } else {
            if ($i == 2) {
              ?> <span class="otherSources">(<?=$this->transEsc('Other Sources')?>: <?
            } else {
              ?>, <?
            }
            ?><a href="<?=$this->recordLink()->getUrl($current['id'])?>"><?=$this->transEsc("source_$source", array(), $source)?></a><?
          }
        }
        if ($i > 1) {
          ?>)</span><?
        }?>
      </div>
      <? endif; ?>

    <? if ($cart->isActive()): ?>
      <div id="bookbag-menu">
        <input id="cartId" type="hidden" name="ids[<?=$this->driver->getUniqueId() ?>]" value="<?=$cartId ?>" />
        <a id="single-cart-add" class="single-cart-add <? if(!$cart->contains($cartId)): ?>correct <? endif ?>hidden fa fa-thumb-tack tub_bookbag_off" href="#" data-recordid="<?=$cartId ?>"> <?=$this->transEsc('Add to Book Bag') ?></a>
        <a id="single-cart-remove" class="single-cart-remove <? if($cart->contains($cartId)): ?>correct <? endif ?>hidden fa fa-thumb-tack tub_bookbag_on" href="#" data-recordid="<?=$cartId ?>"> <?=$this->transEsc('Remove from Book Bag') ?></a>
        <noscript>
          <form method="post" name="addForm" action="<?=$this->url('cart-home')?>">
            <input type="hidden" name="ids[]" value="<?=$cartId ?>" />
            <? if ($cart->contains($cartId)): ?>
              <input class="btn btn-default" type="submit" name="delete" value="<?=$this->transEsc('Remove from Book Bag')?>"/>
            <? else: ?>
              <input class="btn btn-default" type="submit" name="add" value="<?=$this->transEsc('Add to Book Bag')?>"/>
            <? endif; ?>
          </form>
        </noscript>
      </div>
    <? endif; ?>

<!--
<p>Lorem ipsum dolor sit amet consectetuer Integer et Sed ut fringilla. Id urna Morbi Maecenas mauris id ornare consequat tempus id ut. Et Vestibulum elit nec id pede diam auctor nisl Aenean auctor. Tincidunt dolor porta non egestas ante quis in mi sit et. Tempor Aenean tincidunt Morbi interdum Lorem sodales ipsum natoque urna hac. Nisl.</p>
<p>Consequat condimentum hendrerit urna tellus eros pede Phasellus justo orci est. Fermentum metus justo ut at convallis Integer sem interdum vitae ac. Curabitur sollicitudin nisl malesuada magna neque habitasse sit et lobortis Aenean. Felis at est diam leo ut Integer euismod quis est suscipit. Diam Aenean in Pellentesque dictumst sed vitae Nam orci tempor tortor. Nam convallis tincidunt nulla libero pellentesque congue hendrerit augue tortor Ut. Urna montes ac.</p>
<p>Ipsum et tempor elit orci feugiat ultrices at mauris in Nam. Morbi sagittis eget Proin ultrices id nibh lacinia dolor tellus vitae. Porttitor eu facilisi quis tempus mauris fermentum elit sollicitudin malesuada molestie. Eros molestie ridiculus Nullam pretium consequat mattis Vestibulum Nullam suscipit lorem. Tempus cursus porta et et semper ligula nec Integer Proin.</p>
<p>Vitae Lorem nisl id auctor nunc augue Duis rutrum gravida pede. Ut vel pretium Quisque consequat convallis a wisi libero et accumsan. Facilisis lorem Vestibulum in amet faucibus condimentum nec egestas vitae In. Nibh Ut nibh amet aliquam tincidunt Curabitur et justo Sed malesuada. At semper nibh non dolor rutrum Lorem ut fringilla.</p>
<p>Vivamus est neque amet Nullam enim egestas Integer eleifend dolor In. Convallis et Pellentesque magnis ut Curabitur laoreet lacinia nisl cursus Nulla. Vivamus vel Nam Vestibulum nibh Nunc enim pretium Nam malesuada semper. Non sollicitudin augue eros et nulla a nonummy urna sed urna. Ante Phasellus leo facilisi orci nulla hendrerit habitant.</p>
-->

        </div> <!-- end tub-bibliographic -->
        <div class="col-xs-1 tub-FUTURE"></div>
      </div> <!-- end tub-middle-top -->
      <div class="row tub-middle-bottom">
        <div class="col-xs-6 col-sm-2 tub-format">
         <?=str_replace('class="', 'class="tub_label tublabel-info ', $this->record($this->driver)->getFormatList())?>
        </div>
        <div class="col-xs-6 col-sm-2 col-sm-push-8 tub-year text-right">
          <?=!empty($summDate) ? $this->escapeHtml($summDate[0]) : ''?>
        </div>
        <div class="col-xs-12 col-sm-8 col-sm-pull-1 tub-doi">
          <? $doi = $this->driver->getContainerDoi(); ?>
            <? if (!empty($doi)): ?>
              <!-- DOI: <a href="http://dx.doi.org/<?=$doi?>"><?=$doi?></a> -->
              <span class="doi_outer"><span class="doi_prefix">DOI</span><span class="doi_link"><a href="https://dx.doi.org/<?=$doi?>"><?=$doi?></a></span></span>
            <? endif; ?>
        </div>
      </div> <!-- end tub-middle-bottom -->
    </div> <!-- end middle -->

    <div class="col-md-3 col-sm-9 col-xs-8 col-md-offset-0 col-sm-offset-3 col-xs-offset-4 right"> <!-- version for not breaking already at 991 (sm): col-md-3 col-sm-3 col-xs-0 col-sm-offset-0 col-xs-offset-4 right -->
        <span class="tub_holdingguide" record-id="<?=$id?>">
                <!--@todo: I really don't like it here; it should be in themes/bootstrap3-tub/js/check_item_statuses.js -->
                <script>
                  loc_button = create_button(href   = '<?=$this->driver->getTubdokUrl()?>',
                                             hover  = vufindString.loc_modal_Title_tubdok,
                                             text   = 'TUBdok',
                                             icon   = 'fa-university',
                                             css_classes = 'holdelectronic',
                                             target = '_blank');
                  document.write(loc_button);
                </script>
        </span>

      <? /* Display qrcode if appropriate: */ ?>
      <? if ($QRCode = $this->record($this->driver)->getQRCode("results")): ?>
        <?
          // Add JS Variables for QrCode
          $this->jsTranslations()->addStrings(array('qrcode_hide' => 'qrcode_hide', 'qrcode_show' => 'qrcode_show'));
        ?>
        <span class="hidden-xs">
          <i class="fa fa-qrcode"></i> <a href="<?=$this->escapeHtmlAttr($QRCode);?>" class="qrcodeLink"><?=$this->transEsc('qrcode_show')?></a>
          <div class="qrcode hidden">
            <script type="text/template" class="qrCodeImgTag">
              <img alt="<?=$this->transEsc('QR Code')?>" src="<?=$this->escapeHtmlAttr($QRCode);?>"/>
            </script>
          </div><br/>
        </span>
      <? endif; ?>

      <? if ($this->userlist()->getMode() !== 'disabled'): ?>
        <? /* Saved lists */ ?>
        <div class="savedLists alert alert-info hidden">
          <strong><?=$this->transEsc("Saved in")?>:</strong>
        </div>
      <? endif; ?>

      <? /* Hierarchy tree link */ ?>
      <? $trees = $this->driver->tryMethod('getHierarchyTrees'); if (!empty($trees)): ?>
        <? foreach ($trees as $hierarchyID => $hierarchyTitle): ?>
          <div class="hierarchyTreeLink">
            <input type="hidden" value="<?=$this->escapeHtmlAttr($hierarchyID)?>" class="hiddenHierarchyId" />
            <i class="fa fa-sitemap"></i>
            <a class="hierarchyTreeLinkText modal-link" href="<?=$this->recordLink()->getTabUrl($this->driver, 'HierarchyTree')?>?hierarchy=<?=urlencode($hierarchyID)?>#tabnav" title="<?=$this->transEsc('hierarchy_tree')?>">
              <?=$this->transEsc('hierarchy_view_context')?><? if (count($trees) > 1): ?>: <?=$this->escapeHtml($hierarchyTitle)?><? endif; ?>
            </a>
          </div>
        <? endforeach; ?>
      <? endif; ?>

      <?=$this->driver->supportsCoinsOpenUrl()?'<span class="Z3988" title="'.$this->escapeHtmlAttr($this->driver->getCoinsOpenUrl()).'"></span>':''?>
    </div>
  </div>
</div>